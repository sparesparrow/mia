name: Android Device Setup CI/CD

on:
  workflow_dispatch:
    inputs:
      device_serial:
        description: 'Device serial number (leave empty for auto-detection)'
        required: false
        type: string
      install_gapps:
        description: 'Install Google Apps'
        required: false
        default: true
        type: boolean
      install_magisk:
        description: 'Install Magisk root'
        required: false
        default: true
        type: boolean
      skip_tests:
        description: 'Skip post-installation testing'
        required: false
        default: false
        type: boolean
      backup_before_install:
        description: 'Create backup before installation'
        required: false
        default: true
        type: boolean

  schedule:
    # Run weekly health checks on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'

  push:
    branches: [ main, develop ]
    paths:
      - 'scripts/android-device-setup/**'
      - 'android/**'
      - '.github/workflows/setup-android-device.yml'

  pull_request:
    branches: [ main ]
    paths:
      - 'scripts/android-device-setup/**'
      - 'android/**'

env:
  DEVICE_SERIAL: ${{ github.event.inputs.device_serial }}
  INSTALL_GAPPS: ${{ github.event.inputs.install_gapps }}
  INSTALL_MAGISK: ${{ github.event.inputs.install_magisk }}
  SKIP_TESTS: ${{ github.event.inputs.skip_tests }}
  BACKUP_BEFORE_INSTALL: ${{ github.event.inputs.backup_before_install }}
  WORKSPACE_DIR: android-device-workspace

jobs:
  validate-scripts:
    name: Validate Setup Scripts
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Bash
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck

    - name: Validate shell scripts
      run: |
        find scripts/android-device-setup -name "*.sh" -exec shellcheck {} \;

    - name: Check script permissions
      run: |
        find scripts/android-device-setup -name "*.sh" -exec test -x {} \;

    - name: Validate script syntax
      run: |
        find scripts/android-device-setup -name "*.sh" -exec bash -n {} \;

  environment-setup:
    name: Environment Setup
    runs-on: ubuntu-24.04
    needs: validate-scripts

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Android tools
      run: |
        sudo apt-get update
        sudo apt-get install -y android-tools-adb android-tools-fastboot wget curl unzip python3 python3-pip

    - name: Verify environment
      run: |
        cd scripts/android-device-setup/environment
        ./verify-environment.sh

    - name: Upload environment report
      uses: actions/upload-artifact@v4
      with:
        name: environment-report
        path: android-device-workspace/environment-report.txt

  download-assets:
    name: Download Installation Assets
    runs-on: ubuntu-24.04
    needs: environment-setup

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Android tools
      run: |
        sudo apt-get update
        sudo apt-get install -y android-tools-adb android-tools-fastboot wget curl unzip

    - name: Download LineageOS and GApps
      run: |
        cd scripts/android-device-setup/rom
        ./rom-manager.sh download-all

    - name: Download Magisk
      run: |
        cd scripts/android-device-setup/root
        ./magisk-manager.sh download

    - name: Download TWRP
      run: |
        cd scripts/android-device-setup/recovery
        ./twrp-manager.sh download

    - name: Upload downloaded assets
      uses: actions/upload-artifact@v4
      with:
        name: installation-assets
        path: |
          android-device-workspace/downloads/
        retention-days: 7

  test-scripts:
    name: Test Setup Scripts
    runs-on: ubuntu-24.04
    needs: download-assets

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download assets
      uses: actions/download-artifact@v4
      with:
        name: installation-assets
        path: android-device-workspace/downloads/

    - name: Test ROM manager
      run: |
        cd scripts/android-device-setup/rom
        ./rom-manager.sh list

    - name: Test Magisk manager
      run: |
        cd scripts/android-device-setup/root
        ./magisk-manager.sh version

    - name: Test TWRP manager
      run: |
        cd scripts/android-device-setup/recovery
        ./verify-recovery.sh version

    - name: Generate test reports
      run: |
        cd scripts/android-device-setup/reporting
        ./generate-report.sh all

    - name: Upload test reports
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: android-device-workspace/reports/
        retention-days: 30

  device-health-check:
    name: Device Health Check
    runs-on: ubuntu-24.04
    needs: test-scripts
    if: github.event_name == 'schedule' || contains(github.event.inputs, 'device_serial')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Android tools
      run: |
        sudo apt-get update
        sudo apt-get install -y android-tools-adb android-tools-fastboot

    - name: Device health check
      run: |
        cd scripts/android-device-setup/testing
        if [[ -n "${DEVICE_SERIAL}" ]]; then
          ./health-check.sh full "${DEVICE_SERIAL}"
        else
          echo "No device serial provided - skipping device health check"
        fi

    - name: Upload health reports
      uses: actions/upload-artifact@v4
      with:
        name: health-reports
        path: android-device-workspace/health-check-report.txt
        retention-days: 30

  automated-installation:
    name: Automated Device Installation
    runs-on: ubuntu-24.04
    needs: device-health-check
    if: github.event_name == 'workflow_dispatch' && contains(github.event.inputs, 'device_serial')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download installation assets
      uses: actions/download-artifact@v4
      with:
        name: installation-assets
        path: android-device-workspace/downloads/

    - name: Install Android tools
      run: |
        sudo apt-get update
        sudo apt-get install -y android-tools-adb android-tools-fastboot wget curl unzip

    - name: Set installation configuration
      run: |
        export DEVICE_SERIAL="${DEVICE_SERIAL}"
        export INSTALL_GAPPS="${INSTALL_GAPPS:-true}"
        export INSTALL_MAGISK="${INSTALL_MAGISK:-true}"
        export BACKUP_BEFORE_INSTALL="${BACKUP_BEFORE_INSTALL:-true}"

        cd scripts/android-device-setup/installation
        ./install-lineageos.sh --device "${DEVICE_SERIAL}" \
                              $([ "${INSTALL_GAPPS}" = "false" ] && echo "--no-gapps") \
                              $([ "${INSTALL_MAGISK}" = "false" ] && echo "--no-root")

    - name: Run post-installation tests
      if: env.SKIP_TESTS != 'true'
      run: |
        cd scripts/android-device-setup/testing
        ./health-check.sh full "${DEVICE_SERIAL}"
        ./test-suite.sh full "${DEVICE_SERIAL}"

    - name: Generate installation report
      run: |
        cd scripts/android-device-setup/reporting
        ./generate-report.sh comprehensive "${DEVICE_SERIAL}"

    - name: Upload installation logs
      uses: actions/upload-artifact@v4
      with:
        name: installation-logs
        path: |
          android-device-workspace/logs/
          android-device-workspace/reports/
        retention-days: 30

    - name: Create backup after installation
      run: |
        cd scripts/android-device-setup/backup
        ./backup-manager.sh create full "${DEVICE_SERIAL}"

  device-pool-management:
    name: Device Pool Management
    runs-on: ubuntu-24.04
    needs: automated-installation
    if: always() && github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Update device pool status
      run: |
        # This would integrate with a device pool management system
        echo "Device ${DEVICE_SERIAL} installation completed with status: ${{ needs.automated-installation.result }}"

        # Update device status in pool
        mkdir -p device-pool
        echo "${DEVICE_SERIAL},$(date),${{ needs.automated-installation.result }},${INSTALL_GAPPS},${INSTALL_MAGISK}" >> device-pool/status.csv

    - name: Upload device pool status
      uses: actions/upload-artifact@v4
      with:
        name: device-pool-status
        path: device-pool/
        retention-days: 30

  cleanup:
    name: Cleanup
    runs-on: ubuntu-24.04
    needs: [validate-scripts, environment-setup, download-assets, test-scripts, device-health-check, automated-installation, device-pool-management]
    if: always()

    steps:
    - name: Clean up artifacts
      run: |
        echo "Workflow completed with overall status: ${{ job.status }}"
        echo "Automated installation status: ${{ needs.automated-installation.result }}"

    - name: Generate workflow summary
      run: |
        echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Script Validation | ${{ needs.validate-scripts.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Environment Setup | ${{ needs.environment-setup.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Asset Downloads | ${{ needs.download-assets.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Script Testing | ${{ needs.test-scripts.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Device Health Check | ${{ needs.device-health-check.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Automated Installation | ${{ needs.automated-installation.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Device Pool Management | ${{ needs.device-pool-management.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "${{ needs.automated-installation.result }}" == "success" ]]; then
          echo "‚úÖ **Automated device setup completed successfully!**" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.automated-installation.result }}" == "skipped" ]]; then
          echo "‚è≠Ô∏è **Automated installation was skipped**" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Automated device setup failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Troubleshooting steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the installation logs artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Review device connection and permissions" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify device is in the correct state (bootloader unlocked)" >> $GITHUB_STEP_SUMMARY
          echo "4. Run manual recovery procedures if needed" >> $GITHUB_STEP_SUMMARY
        fi

  notify:
    name: Notification
    runs-on: ubuntu-24.04
    needs: cleanup
    if: always() && github.event_name == 'workflow_dispatch'

    steps:
    - name: Send notification
      run: |
        echo "Sending workflow completion notification..."
        # This would integrate with notification services (Slack, Discord, etc.)
        echo "Workflow completed: ${{ job.status }}"

        if [[ "${{ needs.automated-installation.result }}" == "success" ]]; then
          echo "üéâ Device setup completed successfully!"
        else
          echo "‚ö†Ô∏è Device setup encountered issues"
        fi