name: Raspberry Pi C++ Build

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'platforms/cpp/**'
      - 'scripts/build-raspberry-pi.sh'
      - 'scripts/deploy-raspberry-pi.sh'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'platforms/cpp/**'
      - 'scripts/build-raspberry-pi.sh'
      - 'scripts/deploy-raspberry-pi.sh'
  workflow_dispatch:

env:
  BUILD_DIR: build-raspberry-pi

jobs:
  build-raspberry-pi:
    name: Build C++ for Raspberry Pi
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            libcurl4-openssl-dev \
            libmosquitto-dev \
            libgpiod-dev \
            libjsoncpp-dev \
            libflatbuffers-dev \
            espeak \
            mosquitto \
            mosquitto-clients

      - name: Create build directory
        run: |
          mkdir -p ${{ env.BUILD_DIR }}
          cd ${{ env.BUILD_DIR }}

      - name: Configure CMake
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          cmake ../platforms/cpp/core \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=g++ \
            -DCMAKE_C_COMPILER=gcc

      - name: Build
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          make -j$(nproc)

      - name: Run tests
        working-directory: ${{ env.BUILD_DIR }}
        continue-on-error: true
        run: |
          if [ -f tests ]; then
            ./tests || echo "Tests failed but continuing"
          else
            echo "Tests not built, skipping"
          fi

      - name: Upload binaries
        uses: actions/upload-artifact@v3
        with:
          name: raspberry-pi-binaries
          path: |
            ${{ env.BUILD_DIR }}/ai-servis-rpi
            ${{ env.BUILD_DIR }}/hardware-server
            ${{ env.BUILD_DIR }}/tests
          if-no-files-found: warn

      - name: Check binary sizes
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          echo "Binary sizes:"
          ls -lh ai-servis-rpi hardware-server 2>/dev/null || true
          echo ""
          echo "Checking for required binaries:"
          [ -f ai-servis-rpi ] && echo "✓ ai-servis-rpi found" || echo "✗ ai-servis-rpi missing"
          [ -f hardware-server ] && echo "✓ hardware-server found" || echo "✗ hardware-server missing"

  build-cross-compile:
    name: Cross-compile for ARM (Raspberry Pi)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            cmake \
            pkg-config \
            qemu-user-static

      - name: Cross-compile for ARM64
        run: |
          mkdir -p build-arm64
          cd build-arm64
          cmake ../platforms/cpp/core \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DCMAKE_FIND_ROOT_PATH=/usr/aarch64-linux-gnu \
            -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \
            -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
            -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY
          make -j$(nproc) || echo "Cross-compilation may require additional setup"

      - name: Upload cross-compiled binaries
        uses: actions/upload-artifact@v3
        if: success()
        with:
          name: raspberry-pi-arm64-binaries
          path: build-arm64/ai-servis-rpi
          if-no-files-found: ignore
