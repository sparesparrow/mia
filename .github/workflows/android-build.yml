name: Android APK Build & Test

on:
  push:
    branches: [ main, develop, feat/citroen-telemetry-agent ]
    paths:
      - 'android/**'
      - '.github/workflows/setup-android-device.yml'

  pull_request:
    branches: [ main, develop ]
    paths:
      - 'android/**'

env:
  WORKSPACE_DIR: android-device-workspace

jobs:
  android-build:
    name: ðŸ“± Android APK Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Grant execute permission for gradlew
      run: chmod +x android/gradlew

    - name: Build debug APK
      run: |
        cd android
        ./gradlew assembleDebug --no-daemon

    - name: Run unit tests
      run: |
        cd android
        ./gradlew testDebugUnitTest --no-daemon

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-debug-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: android-test-results
        path: android/app/build/reports/tests/

  docker-test:
    name: ðŸ³ Android Docker Tests
    runs-on: ubuntu-latest
    needs: android-build

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: android-debug-apk
        path: ./apk/

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Android test environment
      run: |
        docker build -f android/Dockerfile.test -t mia-android-test ./android

    - name: Run Android instrumentation tests in Docker
      run: |
        # Copy APK to expected location for Docker
        cp ./apk/app-debug.apk ./android/app/build/outputs/apk/debug/

        # Run tests in container (this would need proper Android emulator setup)
        echo "Android instrumentation tests would run here with proper emulator setup"
        echo "For now, we're validating the Docker build and APK structure"

    - name: Validate APK structure
      run: |
        apk_path="./apk/app-debug.apk"
        if [ -f "$apk_path" ]; then
          echo "âœ… APK file exists: $(ls -lh $apk_path)"
          echo "APK size: $(stat -c%s $apk_path) bytes"

          # Basic APK validation (unzip and check structure)
          unzip -l "$apk_path" | head -20
        else
          echo "âŒ APK file not found"
          exit 1
        fi

  security-scan:
    name: ðŸ”’ Android Security Scan
    runs-on: ubuntu-latest
    needs: android-build

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: android-debug-apk
        path: ./apk/

    - name: Run Trivy security scan on APK
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: './apk/'
        format: 'sarif'
        output: 'trivy-android-results.sarif'

    - name: Upload Trivy results
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: 'trivy-android-results.sarif'

  summary:
    name: ðŸ“Š Build Summary
    runs-on: ubuntu-latest
    needs: [android-build, docker-test, security-scan]
    if: always()

    steps:
    - name: Generate build summary
      run: |
        echo "## Android Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| APK Build | ${{ needs.android-build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Docker Tests | ${{ needs.docker-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "${{ needs.android-build.result }}" == "success" ]]; then
          echo "âœ… **Android APK built successfully!**" >> $GITHUB_STEP_SUMMARY

          # Show APK details
          if [ -f "./apk/app-debug.apk" ]; then
            echo "ðŸ“± APK Details:" >> $GITHUB_STEP_SUMMARY
            echo "- Size: $(stat -c%s ./apk/app-debug.apk) bytes" >> $GITHUB_STEP_SUMMARY
            echo "- Build: $(date)" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ **Android build failed**" >> $GITHUB_STEP_SUMMARY
        fi